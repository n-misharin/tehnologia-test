# Задание 1

## Условие

Написать программу на Java для копирования class-файлов из заданного каталога в структуру каталогов в
соответствии с полным названием java-класса.

## Решение

Код решения находится в файле `src/UpdateClassFile.java`. При запуске копирует class-файлы из каталога `task/update` в
каталог `task` (каталог `com` тоже там).

# Задание 2

Написать SQL-запрос, который вернет список объектов (`id_object`) где умер последний
собственник более указанного количества месяцев и на момент смерти последнего собственника не
было ни одного живого зарегистрированного (`id_residence_type=1`). При реализации следует учесть,
что задание сформулировано так что должны корректно обрабатывается ситуация, когда человек
умирает например 01.01.2005, а его выписывают 25.01.2005 (или забывают выписать).

## Решение

Сам файл с запросом находится в `sql/solution.sql`.

## Ход решения задачи на SQL

В условии написано "На основании персональных документов контрагенты ... получают право собственности на объекты.". Т.е.
есть таблица "personal_doc_property" (Подтверждение права на объект), в которой можно найти всех собственников объекта.
Будем считать что записи из этой таблице не удаляются, поэтому прошлые собственники там тоже присутствуют. Однако, в
этой таблице нет даты, когда это право собственности вступает в силу. Наверно, эта дата есть в каком-то персональном
документе (`personal_doc`), который связан с записью в таблице `personal_doc_property`. Получается, чтобы найти одного
из последних (судя по таблице `personal_doc_property` собственников может быть несколько, каждый из которых владеет
какой-то частью объекта) собственников определенного объекта, нужно в таблице с подтверждениями права на
объект (`personal_doc_property`) найти запись, которая связана персональным документом (`personal_doc`) с максимальной
датой начала действия документа (`personal_doc.begin_date`).

Однако, для поиска всех собственников объекта (разные контрагенты могут владеть разными частями объекта) только
информации о дате начала действия документа недостаточно.

### Пример

Рассмотрим таблицу переходов собственности
<table>
    <thead>
        <tr>
            <th rowspan="2">Часть собствнности</th>
            <th colspan="4">Дата перехода собственности</th>
        </tr>
        <tr> 
            <th>2023-01-01</th>    
            <th>2023-02-01</th>    
            <th>2023-03-01</th>    
            <th>2020-04-01</th>  
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1 / 2 квартиры </td>
            <td> Андрей </td>
            <td> Петя </td>
            <td> </td>
            <td> </td>
        </tr>
        <tr>
            <td>1 / 2 квартиры </td>
            <td> Андрей </td>
            <td>  </td>
            <td> Вася </td>
            <td> Семен </td>
        </tr>
    </tbody>
</table>

Дата получения собственнсоти Васей больше чем дата получения другой части этой собствнности Петей. Но Вася не последний
владелец этой части собственности (она позже перешла к Семену).

Поэтому нужно:

1) либо чтобы из таблицы Подтверждение собственности (`personal_doc_property`) удалялись прошлые владельцы
   собствености (
   т.е. хранились) только текущие;
2) либо документ (из `personal_doc`), который связан с подтверждением права собственности (`personal_doc_property`),
   получал дату окончания.

Далее будем считать, что выполняется именно второй пункт.

Но тогда еще остаются следующие вопросы:

1) Какая будет стоять дата окончания документа о подтверждении собственности, если человек умер?
2) Может ли человек прописаться на объекте, если все собственники мертвы?

Примем следующие ответы:

1) Дата окончания документа появится тогда, когда вступ в силу новый документ о подтверждении собственности или объект
   будет снесен. Т.е. умерший до этой даты будет владеть собственностью.
2) Будем считать, что можно прописаться, если все собственники мертвы.

Получается, чтобы найти всех текущих владельцев объекта, нужно найти все действующие (без срока окончания
-- `NULL`) документы на подтверждение права собственности. Проверять, что объект снесен не нужно, т.к. у таких объектов
по п.1. уже дата окончания документа не будет пустой.

Найдем объекты где мертвы все собственники (и дату смерти последнего собственника этого объекта)

```roomsql
WITH object_last_death AS (
    SELECT
        pdp.id_object, -- ид объекта
        pdp.id_agent, -- ид агента (собственника)
        FIRST_VALUE(agent.death_date) OVER (
            PARTITION BY pdp.id_object
            ORDER BY pdp.id_object, agent.death_date DESC NULLS FIRST
        ) AS last_death_date, -- дата смерти последнего собственника или NULL, если хотябы один собственник жив
        agent.death_date -- дата смерти агента (либо NULL)
    FROM
        personal_doc_property AS pdp
    JOIN
        personal_doc AS pd ON pd.id_personal_doc = pdp.id_personal_doc
    JOIN
        agent ON agent.id_agent = pdp.id_agent
    WHERE
        pd.end_date IS NULL -- NULL, если документ подтверждения собственности еще действителен (см. п. 1)
)
```

Выберем объекты, у которых `last_death_date IS NOT NULL` (т.е. мертвы все собственники)

```roomsql
SELECT DISTINCT
    object_last_death.id_object,
    object_last_death.last_death_date
FROM 
    object_last_death 
WHERE
    object_last_death.last_death_date IS NOT NULL;
```

По условию нужно взять где "..умер последний собственник более указанного количества месяцев".
Добавим в запрос выбор по дате (2 месяца назад от сегодняшней даты)" и получим

```roomsql
SELECT DISTINCT
    object_last_death.id_object,
    object_last_death.last_death_date
FROM 
    object_last_death 
WHERE
    object_last_death.last_death_date IS NOT NULL 
    AND object_last_death.last_death_date < DATE(NOW()) - INTERVAL '2 MONTH';
```

Разберемся со следующей частью задачи: "... на момент смерти последнего собственника не было ни одного живого
зарегистрированного (`id_residence_type=1`)". Звучит так, словно другие `id_residence_type` нас просто не интересуют,
поэтому будем искать только с `id_residence_type=1`.

Составим подзапрос, чтобы получить таблицу с фактами проживания резидентов и датами их смертей.

```roomsql
WITH full_residence AS (
	SELECT
	    residence.id_object, residence.id_agent,
	    residence.id_residence_type, residence.begin_date,
	    residence.end_date, agent.death_date
  	FROM residence
  	JOIN agent ON agent.id_agent = residence.id_agent
  	WHERE residence.id_residence_type = 1
)
```

Очень странно звучит "...на момент смерти не было ...". Значит могло появиться после, но такие выбирать не надо...
Ну тогда, чтобы получить ответ, нужно выбрать только те объекты, для которых в `full_residence` нет ни одной записи
удовлетворяющей условию `дата_прописки < дата_смерти_собственника < min(дата_смерти, дата_выписки)`, причем, нужно
считать что `NULL` больше любой даты.

```roomsql
SELECT *
FROM (
   SELECT DISTINCT
        object_last_death.id_object,
        object_last_death.last_death_date
   FROM 
        object_last_death 
   WHERE
        object_last_death.last_death_date IS NOT NULL AND 
        object_last_death.last_death_date < DATE(NOW()) - INTERVAL '2 MONTH'
) as empty_objects
WHERE (
    SELECT COUNT(*)
    FROM full_residence
    WHERE
       empty_objects.id_object = full_residence.id_object AND
       full_residence.begin_date < empty_objects.last_death_date AND (
           empty_objects.last_death_date < full_residence.end_date OR
           empty_objects.last_death_date < full_residence.death_date OR
           full_residence.death_date IS NULL AND full_residence.end_date IS NULL
       )
) = 0
```